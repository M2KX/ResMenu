name: Manual CI

on:
  workflow_dispatch:

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    env:
      SERVER_IP: ${{ secrets.SERVER_IP }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
      SERVER_PATH: ${{ secrets.SERVER_PATH }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------- Validate secrets ----------
      - name: Check required secrets
        run: |
          echo "SERVER_IP:      ${SERVER_IP:-<empty>}"
          echo "SERVER_USER:    ${SERVER_USER:-<empty>}"
          echo "SERVER_PATH:    ${SERVER_PATH:-<empty>}"
          if [ -z "$SERVER_IP" ] || [ -z "$SERVER_USER" ] || [ -z "$SERVER_PASSWORD" ]; then
            echo "‚ùå One or more required secrets are missing (SERVER_IP / SERVER_USER / SERVER_PASSWORD)."
            exit 1
          fi

      # ---------- Backend (.NET) ----------
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore backend
        run: |
          cd backend
          dotnet restore Menufy.sln

      - name: Build backend
        run: |
          cd backend
          dotnet build Menufy.sln -c Release --no-restore

      - name: Publish backend API
        run: |
          cd backend
          dotnet publish src/Menufy.API/Menufy.API.csproj -c Release -o ../publish-backend
          ls -la ../publish-backend

      # ---------- Frontend (Nuxt) ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build
          ls -la .output

      # ---------- Prepare deploy archive ----------
      - name: Create deploy archive
        run: |
          # We are in repo root here
          tar czf deploy.tar.gz publish-backend frontend/.output
          ls -la
          echo "Archive ready: deploy.tar.gz"

      # ---------- Server connection & deploy ----------
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy and run with Docker on server
        run: |
          # Copy archive to server
          sshpass -p "$SERVER_PASSWORD" scp -o StrictHostKeyChecking=no deploy.tar.gz "$SERVER_USER@$SERVER_IP:/tmp/resmenu_deploy.tar.gz"

          # On server: extract + ensure Docker + run containers
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" 'bash -s' << "EOF"
          set -e

          echo "[*] Using SERVER_PATH: '"$SERVER_PATH"'"

          # Make sure target directory exists
          mkdir -p "$SERVER_PATH"

          echo "[*] Extracting new build..."
          tar xzf /tmp/resmenu_deploy.tar.gz -C "$SERVER_PATH"

          echo "[*] Ensuring Docker is installed..."
          if ! command -v docker >/dev/null 2>&1; then
            apt-get update
            apt-get install -y docker.io
            systemctl enable --now docker
          fi

          echo "[*] Stopping old containers (if any)..."
          docker rm -f menufy-backend || true
          docker rm -f menufy-frontend || true

          echo "[*] Starting backend container..."
          docker run -d \
            --name menufy-backend \
            --restart=always \
            -p 5000:5000 \
            -v "$SERVER_PATH/publish-backend:/app" \
            -w /app \
            mcr.microsoft.com/dotnet/aspnet:8.0 \
            dotnet Menufy.API.dll

          echo "[*] Starting frontend container..."
          # frontend extracted as $SERVER_PATH/frontend/.output
          # we mount $SERVER_PATH/frontend as /app and run Nitro server
          mkdir -p "$SERVER_PATH/frontend"
          if [ ! -d "$SERVER_PATH/frontend/.output" ]; then
            # If only frontend/.output exists, ensure parent dir
            mv "$SERVER_PATH/frontend/.output" "$SERVER_PATH/frontend/.output" 2>/dev/null || true
          fi

          docker run -d \
            --name menufy-frontend \
            --restart=always \
            -p 3000:3000 \
            -v "$SERVER_PATH/frontend:/app" \
            -w /app \
            node:20 \
            node .output/server/index.mjs

          echo "[*] Containers running:"
          docker ps
          EOF

      - name: Done
        run: |
          echo "Deployed to: $SERVER_PATH"
