name: Manual CI

on:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      SERVER_IP: ${{ secrets.SERVER_IP }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
      SERVER_PATH: ${{ secrets.SERVER_PATH }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required secrets
        run: |
          echo "SERVER_IP:      ${SERVER_IP:-<empty>}"
          echo "SERVER_USER:    ${SERVER_USER:-<empty>}"
          echo "SERVER_PATH:    ${SERVER_PATH:-<empty>}"
          # Don't print the password value for safety
          if [ -z "$SERVER_IP" ] || [ -z "$SERVER_USER" ] || [ -z "$SERVER_PASSWORD" ]; then
            echo "‚ùå One or more required secrets are missing (SERVER_IP / SERVER_USER / SERVER_PASSWORD)."
            exit 1
          fi

      # ---------- Backend (.NET) ----------
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore backend
        run: |
          cd backend
          dotnet restore Menufy.sln

      - name: Build backend
        run: |
          cd backend
          dotnet build Menufy.sln -c Release --no-restore


      # ---------- Frontend (Node / Nuxt) ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      # ---------- Server connection test (using password) ----------
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Test SSH connection to server
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" "echo Connected to \$(hostname); pwd"

      - name: Show server path (debug)
        run: |
          echo "Will deploy to: $SERVER_PATH"
