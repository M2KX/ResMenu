name: Manual CI

on:
  workflow_dispatch:

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    env:
      SERVER_IP: ${{ secrets.SERVER_IP }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
      SERVER_PATH: ${{ secrets.SERVER_PATH }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------- Validate secrets ----------
      - name: Check required secrets
        run: |
          echo "SERVER_IP:      ${SERVER_IP:-<empty>}"
          echo "SERVER_USER:    ${SERVER_USER:-<empty>}"
          echo "SERVER_PATH:    ${SERVER_PATH:-<empty>}"
          if [ -z "$SERVER_IP" ] || [ -z "$SERVER_USER" ] || [ -z "$SERVER_PASSWORD" ]; then
            echo "‚ùå One or more required secrets are missing (SERVER_IP / SERVER_USER / SERVER_PASSWORD)."
            exit 1
          fi

      # ---------- Backend (.NET) ----------
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore backend
        run: |
          cd backend
          dotnet restore Menufy.sln

      - name: Build backend
        run: |
          cd backend
          dotnet build Menufy.sln -c Release --no-restore

      - name: Publish backend API
        run: |
          cd backend
          dotnet publish src/Menufy.API/Menufy.API.csproj -c Release -o ../publish-backend
          ls -la ../publish-backend

      # ---------- Frontend (Nuxt) ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build
          ls -la .output

      # ---------- Prepare deploy archive ----------
      - name: Create deploy archive
        run: |
          # We are in repo root here
          tar czf deploy.tar.gz publish-backend frontend/.output
          ls -la
          echo "Archive ready: deploy.tar.gz"

      # ---------- Server connection & deploy ----------
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to server
        run: |
          # Ensure target directory exists
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" "mkdir -p '$SERVER_PATH'"

          # Copy archive to server
          sshpass -p "$SERVER_PASSWORD" scp -o StrictHostKeyChecking=no deploy.tar.gz "$SERVER_USER@$SERVER_IP:/tmp/resmenu_deploy.tar.gz"

          # Extract on server into SERVER_PATH
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" "tar xzf /tmp/resmenu_deploy.tar.gz -C '$SERVER_PATH'"

      - name: Show server path (debug)
        run: |
          echo "Deployed to: $SERVER_PATH"
